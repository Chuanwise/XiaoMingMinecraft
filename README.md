### XiaoMingMinecraft
# 小明 Minecraft 互通插件

本插件是运行在 `Bukkit`、`Spigot`、`Paper`、`Pupur`、`Bungee（即将发布）` 等端的 `Minecraft` 服务器 - `QQ` 互通插件。

项目基于小明 `QQ` 机器人框架 [xiaoming-bot](https://github.com/Chuanwise/xiaoming-bot) 开发，这是一款基于 `Mirai` 的插件化、便于上手、简单小巧的通用 QQ 机器人框架。具有非常简单的上下文交互接口。

除了支持最基础的远程执行指令、绑定查询、互通聊天外，本插件还支持跨区域 @、申请执行指令等功能。

**小明及相关插件的技术交流 / 用户 QQ 群 `小明练剑场`** ：[`1028959718`](https://jq.qq.com/?_wv=1027&k=sjBXo6xh)

## 快速开始
### 启动小明本体：`XiaoMingHost`
小明本体需要 `Java 8` 或更高版本的环境。如果你会开设 `Minecraft` 服务器，相信这对你而言并不是问题。

#### 下载 `XiaoMingHost`
小明本体程序名为 `XiaoMingHost`，你可以在 `小明练剑场` 群文件中下载到最新版。它有两个分支，一个是 `XiaoMingHostGraphical`（带有图形用户界面，即将发布）和 `XiaoMingHostTerminal`（纯控制台界面）。推荐使用控制台版本。

#### 准备小明根目录
准备一个新的空文件夹，作为 `小明根目录`。将你下载好的 `XiaoMingHost` 放入其内。

#### 制作启动脚本
随后创建一个文本文件，取名任意。内容如下：

```bash
java -jar XiaoMingHostTerminal-xxx.jar
pause
```

**务必注意**
1. `-jar XiaoMingHostTerminal-xxx.jar` 是一个整体。你可以继续添加其他的 `JVM` 参数，但**请不要**加到 `-jar` 和 `XiaoMingHostTerminal-xxx.jar` 之间。
1. `java`，`-jar` 和 `XiaoMingHostTerminal-xxx.jar` 三个部分之间至少要有一个空格。
1. **请不要**真的原样复制启动脚本内容。请将文件名修改为你下载到的 `XiaoMingHost` 文件的名字。例如，你下载的是 `XiaoMingHostTerminal-4.3.5.jar`（注意版本号是 `4.3.5`），你应该写 `java -jar XiaoMingHostTerminal-4.3.5.jar`。

对于 `Windows` 用户，请将扩展名修改为 `.bat`，例如 `start.bat`。对于 `Linux` 用户，请将扩展名修改为 `.sh`，例如 `start.sh`。这就是小明本体的启动脚本了。

**结尾建议添加一个 `pause` 暂停，方便查看控制台输出。**

![小明本体文件夹示意](http://gchat.qpic.cn/gchatpic_new/1525916855/0-0-EBBB00BEF16585DB9FE758A625515F9A/0?term=2)

如上图，我在桌面创建了 `XiaoMing` 文件夹作为小明本体文件夹，随后下载了 `4.3.5` 版的 `XiaoMingHostTerminal`，并编写了启动脚本。

#### 初次启动小明
##### 此前未使用过Mirai核心的机器人
对于 `Windows` 用户，请双击启动脚本。对于 `Linux` 用户，请执行 `sh start.sh`，启动小明。

初次启动小明时，你需要输入 `QQ` 和密码。**请仔细阅读屏幕输出**，特别在输入密码时，小明不会显示你输入的密码，**这是一种保护机制，看起来就像是无法输入那样。正常输入密码后回车即可**。

初次启动时**极有可能**需要进行滑块验证。**请不要随便关闭弹框。**

首先，你可能遇到形如下面的滑动验证码弹窗。

![滑动验证码](http://gchat.qpic.cn/gchatpic_new/1525916855/0-0-E205F515CB2274054371704547121FD1/0?term=2)

如果你使用苹果手机，请寻找使用安卓手机的朋友，按照下面的步骤协助。

如果你使用安卓手机，请在手机上下载 `滑块验证助手`（你可以在 `小明练剑场` 群文件找到，位于 `滑块验证和登陆设备信息采集器` 文件夹下的 `app-release.apk`），将上图中红框中的文本发送到手机上，打开滑块验证助手，将其粘贴到验证码地址输入栏里，随后点击 `下一步`，完成滑块验证后，你将得到一个 `Ticket`：

![滑块验证助手](http://gchat.qpic.cn/gchatpic_new/1525916855/0-0-0640F6AFA757F8AAAC36AD42F25FF708/0?term=2)

点击复制以复制该 `Ticket`，将其发送回电脑，并粘贴到弹窗偏下方的输入框中（上上图中蓝色框出），随后**关闭**该弹窗。

接下来你还可能遇到型如下图的扫码验证弹窗。

![扫码验证](http://gchat.qpic.cn/gchatpic_new/1525916855/0-0-7173802BDA6770EEDBCD6ABDD9BCEE14/0?term=2)

请点击**蓝色文字**打开扫码验证网页。这个网页极有可能无法加载，就算加载了填写账号信息也是很难过去的，因此我们使用扫码验证。

找到网址中的 `verify`，如下图所示：

![扫码验证地址中的verify](http://gchat.qpic.cn/gchatpic_new/1525916855/0-0-F5E953E428D8C7821C63814CDCCD7E27/0?term=2)

将它改为 `qrcode`，如下图所示：

![扫码验证地址中的verify改为qrcode](http://gchat.qpic.cn/gchatpic_new/1525916855/0-0-428AB2F2041102C473610565D7526599/0?term=2)

随后确定，就可以打开扫码验证界面。使用登陆了机器人的手机 `QQ` 扫码，通过验证后关闭刚才的扫码验证弹窗即可。

如果继续遇到弹窗，很可能是刚才某一步没有验证成功。弹窗无非两种，扫码验证和滑块验证，按照上面的方法再试即可。

如果一切顺利，你将通过登录安全验证，并启动小明，如下图所示。

![启动成功时的输出](http://gchat.qpic.cn/gchatpic_new/1525916855/0-0-ACE1E05C8EC4C7684DA085D6FBEC54F9/0?term=2
)

当你看到形如 `小明机器人启动完成` 的语句时，恭喜你，你成功启动了 `XiaoMingHost`！后续你可以直接启动，不需要再次进行初次启动的安全验证了。

后续再使用 `Mirai` 核心的 `QQ` 机器人登录该机器人 `QQ` 号时，你可以直接使用小明产生的设备信息，它位于 `小明根目录/launcher/device.json` 下。

##### 此前使用过Mirai核心的机器人
如果你此前使用过 `Mirai` 核心的 `QQ` 机器人插件，可以在小明根目录下创建 `launcher` 并将此前机器人的设备信息 `device.json` 复制到该文件夹下。这样可以避免进行初次登陆的安全验证。

对于 `Windows` 用户，请双击启动脚本。对于 `Linux` 用户，请执行 `sh start.sh`，启动小明。你很有可能不再遇到安全验证，可以直接进行下一步操作。如果你遇到了安全验证之类操作，请按照 [ Mirai核心的机器人](#此前未使用过Mirai核心的机器人) 的步骤操作。

### 完成基础配置
#### 给自己最高权限
在小明的后台（以后称为 `小明控制台`）输入 `op [你的QQ]`，例如 `op 1437100907`，将自己任命为管理员。

如果输入时后台有输出信息，则需要重新输入一次，确保指令在完整的一行上，如下图所示。

![任命成功时的输出](http://gchat.qpic.cn/gchatpic_new/1525916855/0-0-C20716477EA169149FA9D40522A480F1/0?term=2)

#### 关闭小明的方式
如果需要关闭小明控制台，**最好**在后台输入 `stop`，**而不是直接关闭（这可能造成一些数据丢失）。**

#### 修改登录协议（可选）
默认情况下，机器人是以安卓手机 `QQ` 用户身份登录的。如果你再使用安卓手机 `QQ` 登录机器人的账号，它将被挤下线。

你可以在关闭小明控制台后 `小明根目录/launcher/launcher.json` 中找到 `protocol`，它的值默认是 `ANDROID_PHONE`，如下图所示：

![默认的协议设置](http://gchat.qpic.cn/gchatpic_new/1525916855/0-0-17AA63068515744BEEBA6CDA3B85DBEC/0?term=2)

你可以将它修改为 `ANDROID_PAD`（安卓平板协议），如下图所示：

![修改为安卓平板协议](http://gchat.qpic.cn/gchatpic_new/1525916855/0-0-57847D2BB748E3B760534BE9DA36FDA0/0?term=2)

请务必注意，**不要删除**周围的英文半角双引号 `"`。

`protocol` 控制登录小明的协议，所有取值如下：

|`protocol`|协议|说明|
|----|----|----|
|`ANDROID_PHONE`|安卓手机 `QQ`|是默认的登录方式，具有戳一戳等完整的功能|
|`ANDROID_PAD`|安卓平板|无法发送戳一戳消息|
|`ANDROID_PHONE`|安卓手表|无法发送戳一戳消息|

### 让小明连接服务器
关闭小明后，在小明练剑场群中下载到 `XiaoMingMinecraft` 插件，将它放入 `Bukkit 1.7` 或更高版本的服务器后台（是，你没看错，小明支持 `1.7`）和 `小明根目录/plugins/` 下。随后分别重启或启动 `Minecraft` 服务器和小明。

小明默认占用的端口是 `23333`。如果该端口没有占用，启动小明时你将看到如下输出：

```log
[2022-01-07 00:45:16] [main] [INFO]  PluginManagerImpl : 正在启动插件：XiaoMingMinecraft
[2022-01-07 00:45:16] [nioEventLoopGroup-3-1] [INFO]  XiaoMingMinecraft : 成功在端口 23333 上启动服务器
```

如果此时没有成功在端口 `23333` 上启动服务器，请查看 [`Minecraft`服务器和小明不在同一台设备上](#`Minecraft`服务器和小明不在同一台设备上) 当中有关修改端口的描述。

#### `Minecraft`服务器和小明在同一台设备上
如果 `Minecraft` 服务器和小明在同一台设备上，小明和服务器初始情况下会自动连接，但小明会拒绝连接。

你将在 `Minecraft` 服务器后台看到如下输出：

```log
[00:46:01] [nioEventLoopGroup-2-1/INFO]: [小明] 成功连接到小明
[00:46:01] [nioEventLoopGroup-2-2/INFO]: [小明] 未成功通过验证，请先私聊小明「迎接新服务器」后使用 /xm connect 再次尝试
```

你将在 `小明控制台` 看到如下输出：

```log
[2022-01-07 00:46:01] [nioEventLoopGroup-3-3] [INFO]  XiaoMingMinecraft : 陌生服务器连接到小明，但因为尚未开启迎新模式，故被拒绝连接
```

请按照提示操作。私聊机器人的 `QQ` 号，发送 `迎接新服务器`，随后在 `Minecraft` 服务器后台输入 `xm connect` 重新连接。你将在后台看到连接验证码，将它发送给小明，并给服务器起一个名字，即可完成初次连接。

> 你已经完成初次连接，接下来请阅读 [配置互通频道](#配置互通频道)

#### `Minecraft`服务器和小明不在同一台设备上
如果 `Minecraft` 服务器和小明不在同一台设备上，则数据需要走公网。

请参照 [修改主机的方式](#修改主机的方式) 将 `Minecraft` 那边的 `XiaoMingMinecraft` 要连接主机设置为小明所在的主机地址。

如果小明所在的主机的 `23333` 端口是开放的，并且小明成功在该端口上启动服务器，则不需要修改端口，否则请参照 [修改端口的方式](#修改端口的方式) 修改端口。

随后在 `Minecraft` 服务器上执行 `xm connect` 让小明再次连接。**如果连接失败，请检查防火墙或云主机入出方向规则**。如果连接成功，请参照 [`Minecraft`服务器和小明在同一台设备上](#`Minecraft`服务器和小明在同一台设备上) 的方式继续连接。

> 你已经完成初次连接，接下来请阅读 [配置互通频道](#配置互通频道)

#### 修改端口的方式
**除非你知道你正在干什么，否则请勿擅自修改端口**

在机器人所在的群聊，或与之的私聊中发送（今后将这样的行为称为 `执行小明指令`）`设置服务器端口  [新端口值]`，例如 `设置服务器端口  23334`。随后发送 `关闭服务器` 和 `启动服务器`。小明将在新的端口上开启服务器。

如果小明回复启动失败，则可能是端口被占用，重新设置一个新的端口再次启动服务器即可。

随后请在 `Minecraft` 服务器后台执行 `xm config port [新端口值]`，例如 `xm config port 23334`。

#### 修改主机的方式
**除非你知道你正在干什么，否则请勿擅自修改主机**

请在 `Minecraft` 服务器后台执行 `xm config host [主机地址]`，例如 `xm config port 127.0.0.1`。

### 配置互通频道
摸了，明天再写